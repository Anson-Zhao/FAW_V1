<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../untitled2/CSS/style_final.css" type="text/css">
    <title>FAO Data Entry</title>
    <!--<style>
       h3, input, span {
           float: none; /* if you had floats before? otherwise inline-block will behave differently */
           display: inline-block;
           vertical-align: middle;
       }

        img {
            border-style: ridge;
        }

        /* The Modal (background) */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            padding-top: 100px; /* Location of the box */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        /* Modal Content */
        #modal-content {
            position: relative;
            background-color: #fefefe;
            margin: auto;
            padding: 0;
            border: 1px solid #888;
            width: 80%;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
            -webkit-animation-name: animatetop;
            -webkit-animation-duration: 0.4s;
            animation-name: animatetop;
            animation-duration: 0.4s
        }

        /* Add Animation */
        @-webkit-keyframes animatetop {
            from {top:-300px; opacity:0}
            to {top:0; opacity:1}
        }

        @keyframes animatetop {
            from {top:-300px; opacity:0}
            to {top:0; opacity:1}
        }

        /* The Close Button */
        #close {
            color: white;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        #close:hover,
        #close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        #modal-header {
            padding: 2px 16px;
            background-color: #5cb85c;
            color: white;
        }

        #modal-body {padding: 2px 16px;}

        #modal-footer {
            padding: 2px 16px;
            background-color: #5cb85c;
            color: white;
        }
    </style>-->
</head>
<body>
    <div id="modal" class="modal">
        <!-- Modal content -->
        <div id="modal-content">
            <div id="modal-header">
                <span id="close"></span>
                <h2 id="header"></h2>
            </div>
            <div id="modal-body">
                <p id="body"></p>
            </div>
            <div id="modal-footer">
            </div>
        </div>
    </div>

    <h1>FAO Data Entry</h1>
    <div id="container">
        <h3>Date: &nbsp;&nbsp;&nbsp;</h3><input class="date"><br>
        <h3>Location: &nbsp;&nbsp;&nbsp;</h3><input id="location" type="text"><br>
        <h3>GPS Location: &nbsp;&nbsp;&nbsp;</h3><input id="GPSLocation" type="text"><br>
        <h3 id="mainCropTitle">Main Crop: &nbsp;&nbsp;&nbsp;</h3><br>
        <h3>Crop Variety: &nbsp;&nbsp;&nbsp;</h3><input id="cropVariety" type="text"><br>
        <h3 id="cropSystemTitle">Cropping System: &nbsp;&nbsp;&nbsp;</h3><br>
        <h3>Planting Date: &nbsp;&nbsp;&nbsp;</h3><input class="date"><br>
        <h3>Field Size - ha (numerical XXXX.X): &nbsp;&nbsp;&nbsp;</h3><input id="fieldSizeInteger" type="number" min="0" max="999999" placeholder="0000" onkeyup="limit()">.<input id="fieldSizeDecimal" type="number" maxlength="1" min="0" max="999" placeholder="0" onkeyup="limit()"><br>
        <h3>Date of Last RainFall: &nbsp;&nbsp;&nbsp;</h3><input class="date"><br>
        <h3 id="pestSpeciesTitle">Pest Species: &nbsp;&nbsp;&nbsp;</h3><br><br>
        <h3>Presence or Absence: &nbsp;&nbsp;&nbsp;</h3>
        <input id="presence" type="radio" name="status" value="Presence"> Presence
        <input id="absence" type="radio" name="status" value="Absence"> Absence <br>
        <h3 id="stageTitle">Stage: &nbsp;&nbsp;&nbsp;</h3><br>
        <h3>Number (Numerical) per Plant (Crops): &nbsp;&nbsp;&nbsp;</h3><input id="numPerPlant" type="text"><br>
        <h3>Number (Numerical) per m2 (Pastures): &nbsp;&nbsp;&nbsp;</h3><input id="numPerPastures" type="text"><br>
        <h3>Number (Numerical) per Trap: &nbsp;&nbsp;&nbsp;</h3><input id="numPerTrap" type="text"><br>
        <h3>% Crop Infested (Numerical): &nbsp;&nbsp;&nbsp;</h3><input id="cropInfested" type="text"><br>
        <h3 id="controlTitle">Control: &nbsp;&nbsp;&nbsp;</h3><br>
        <h3 id="ifPesticideTitle">If pesticide: amount in litres (numerical, XX.X): &nbsp;&nbsp;&nbsp;</h3><br>

        <form id = "uploadForm" enctype = "multipart/form-data" action = "http://localhost:9088/upload" method = "post">
            <h3>Photos of pest at different stages: &nbsp;&nbsp;&nbsp;</h3><input id="photoOfPest" type="file" name="photoOfPest" accept="image/*" onchange="previewFile()" multiple/><br><img id="photoOfPestImage" src="" alt="Image preview..."><br>
            <h3>Photos maize at all stages of damage: &nbsp;&nbsp;&nbsp;</h3><input id="photoOfDamage" type="file" name="photoOfDamage" accept="image/*" onchange="previewFile()" multiple/><br><img id="photoOfDamageImage" src="" alt="Image preview..."><br><br>
            <input onclick="undisableBtn()" type="submit" value="Upload Images">
        </form>
    </div>
    <input id="myBtn" type="button" value="Submit the Form" onclick="submit()" disabled>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/flatpickr/dist/flatpickr.min.css">
<script src="https://unpkg.com/flatpickr"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="http://malsup.github.com/jquery.form.js"></script>
<script>

    flatpickr(".date", {
        dateFormat: "Y-m-d",
        time_24hr: true
    });

    var info = [];

    var endSelectTag = $("</select>");

    // main crop option
    var mainCropList = ["Maize", "Rice", "Sorghum", "Vegetables", "Other"];

    var mainCropTitle = $("#mainCropTitle");
    var mainCropSelect = $("<select id='mainCrop' onchange='otherMainCrop()'>");
    mainCropTitle.append(mainCropSelect);
    mainCropSelect.append($("<option value=''>Select the Main Crop</option>"));
    for (var i = 0; i < mainCropList.length; i++) {
        var mainCropOption = $("<option>" + mainCropList[i] + "</option>");
        mainCropSelect.append(mainCropOption);
    }
    mainCropTitle.append(endSelectTag);

    // crop system option
    var cropSystemList = ["Rotation", "Intercropping"];

    var cropSystemTitle = $("#cropSystemTitle");
    var cropSystemSelect = $("<select id='cropSystem'>");
    cropSystemTitle.append(cropSystemSelect);
    cropSystemSelect.append($("<option value=''>Select the Crop System</option>"));
    for (var i = 0; i < cropSystemList.length; i++) {
        var cropSystemOption = $("<option>" + cropSystemList[i] + "</option>");
        cropSystemSelect.append(cropSystemOption);
    }
    cropSystemTitle.append(endSelectTag);

    // pest species option
    var pestSpeciesList = ["FAW", "AAW", "Stalk Borer"];

    var pestSpeciesTitle = $("#pestSpeciesTitle");
    var pestSpeciesSelect = $("<select id='pestSpecies'>");
    pestSpeciesTitle.append(pestSpeciesSelect);
    pestSpeciesSelect.append($("<option value=''>Select the Pest Species</option>"));
    for (var i = 0; i < pestSpeciesList.length; i++) {
        var pestSpeciesOption = $("<option>" + pestSpeciesList[i] + "</option>");
        pestSpeciesSelect.append(pestSpeciesOption);
    }
    pestSpeciesTitle.append(endSelectTag);

    // stage option
    var stageList = ["Egg", "Larval Instar 1", "Larval Instar 2", "Larval Instar 3", "Larval Instar 4", "Larval Instar 5", "Larval Instar 6", "Adult"];

    var stageTitle = $("#stageTitle");
    var stageSelect = $("<select id='stage'>");
    stageTitle.append(stageSelect);
    stageSelect.append($("<option value=''>Select the Stage</option>"));
    for (var i = 0; i < stageList.length; i++) {
        var stageOption = $("<option>" + stageList[i] + "</option>");
        stageSelect.append(stageOption);
    }
    stageTitle.append(endSelectTag);

    // control option
    var controlList = ["Hand Picking", "Pesticide Spray", "Mechanical", "Other"];

    var controlTitle = $("#controlTitle");
    var controlSelect = $("<select id='control' onchange='otherControl()'>");
    controlTitle.append(controlSelect);
    controlSelect.append($("<option value=''>Select the Control Type</option>"));
    for (var i = 0; i < controlList.length; i++) {
        var controlOption = $("<option>" + controlList[i] + "</option>");
        controlSelect.append(controlOption);
    }
    controlTitle.append(endSelectTag);

    // If Pesticide option
    var ifPesticideList = ["No", "Yes"];

    var ifPesticideTitle = $("#ifPesticideTitle");
    var ifPesticideSelect = $("<select id='ifPesticide' onchange='ifPesticide()'>");
    ifPesticideTitle.append(ifPesticideSelect);

    for (var i = 0; i < ifPesticideList.length; i++) {
        var ifPesticideOption = $("<option>" + ifPesticideList[i] + "</option>");
        ifPesticideSelect.append(ifPesticideOption);
    }
    ifPesticideTitle.append(endSelectTag);


    function otherMainCrop() {
        if (document.getElementById("mainCrop").value === "Other") {
            var mainCropTitle = $("#mainCropTitle");
            mainCropTitle.append("<span id='otherMainCropDiv'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>");
            mainCropTitle.append($("<input id='otherMainCrop' type='text'>"));
        } else {
            $("#otherMainCropDiv").remove();
            $("#otherMainCrop").remove();
        }
    }

    function otherControl() {
        if (document.getElementById("control").value === "Other") {

            var controlTitle = $("#controlTitle");
            controlTitle.append("<span id='otherControlDiv'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>");
            controlTitle.append($("<input id='otherControl' type='text'>"));
        } else {
            $("#otherControlDiv").remove();
            $("#otherControl").remove();
        }
    }

    function limit() {
        var key = event.which || event.keyCode;
        var activeElementId = document.activeElement.id;
        //alert(activeElementId);
        if (activeElementId === "fieldSizeInteger") {
            var four_digit = document.getElementById("fieldSizeInteger").value;

            if (key === 190) {
                //alert("a");
                //alert(document.getElementById("fieldSizeInteger").value);
                document.getElementById("fieldSizeInteger").value = four_digit + "00000";

                document.getElementById("fieldSizeDecimal").focus();
            }

            if (document.getElementById("fieldSizeInteger").value.length > 4) {
                //alert("b");
                //alert(four_digit + " " + four_digit.length);

                document.getElementById("fieldSizeInteger").value = four_digit.substring(0, 4);
            }
        } else if (activeElementId === "fieldSizeDecimal") {
            var one_digit = document.getElementById("fieldSizeDecimal").value;

            if (one_digit.length > 1) {
                document.getElementById("fieldSizeDecimal").value = one_digit.substring(0, 1);
            }
        } else if (activeElementId === "amountOfPesticideInteger") {
            var two_digit = document.getElementById("amountOfPesticideInteger").value;

            if (key === 190) {
                //alert("a");
                //alert(document.getElementById("fieldSizeInteger").value);
                document.getElementById("amountOfPesticideInteger").value = two_digit + "00000";

                document.getElementById("amountOfPesticideDecimal").focus();
            }

            if (document.getElementById("amountOfPesticideInteger").value.length > 2) {
                //alert("a");
                //alert(four_digit + " " + four_digit.length);

                document.getElementById("amountOfPesticideInteger").value = two_digit.substring(0, 2);
            }
        } else if (activeElementId === "amountOfPesticideDecimal") {
            var one_digit = document.getElementById("amountOfPesticideDecimal").value;

            if (one_digit.length > 1) {
                document.getElementById("amountOfPesticideDecimal").value = one_digit.substring(0, 1);
            }
        }
    }

    function ifPesticide() {
        if (document.getElementById("ifPesticide").value === "Yes") {

            var ifPesticideTitle = $("#ifPesticideTitle");
            //ifPesticideTitle.append("<span id='amountOfPesticideDiv'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>");
            ifPesticideTitle.append($("<br><input id='amountOfPesticideInteger' type='number' min='0' max='9999' placeholder='00' onkeyup='limit()'><span id='decimalPoint'>.</span><input id='amountOfPesticideDecimal' type='number' maxlength='1' min='0' max='999' placeholder='0' onkeyup='limit()'>"));
        } else {
            $("#amountOfPesticideDiv").remove();
            $("#amountOfPesticideInteger").remove();
            $("#amountOfPesticideDecimal").remove();
            $("#decimalPoint").remove();
        }
    }

    function previewFile() {
        var activeElementId = document.activeElement.id;
        if (activeElementId === "photoOfPest") {

            var preview = document.getElementById("photoOfPestImage");
            var file = document.getElementById("photoOfPest").files[0];
            var reader = new FileReader();

            alert(file);

            reader.addEventListener("load", function () {
                preview.src = reader.result;
            }, false);

            if (file) {
                reader.readAsDataURL(file);
            }

            preview.style.display = "block";

        } else if (activeElementId === "photoOfDamage") {

            var preview = document.getElementById("photoOfDamageImage");
            var file = document.getElementById("photoOfDamage").files[0];
            var reader = new FileReader();

            reader.addEventListener("load", function () {
                preview.src = reader.result;
            }, false);

            if (file) {
                reader.readAsDataURL(file);
            }

            preview.style.display = "block";
        }
    }



    var options = {
        type:      'post',        // 'get' or 'post', override for form's 'method' attribute
        dataType:  'json',        // 'xml', 'script', or 'json' (expected server response type)
        clearForm: true,        // clear all form fields after successful submit
        beforeSubmit:  showRequest,  // pre-submit callback
        success:       showResponse  // post-submit callback

        //target:        '#output2',   // target element(s) to be updated with server response
        // other available options:
        //url:       'http://localhost:3000/api/photo',         // override for form's 'action' attribute
        //resetForm: true        // reset the form after successful submit
        // $.ajax options can be used here too, for example:
        //timeout:   3000
    };

    // bind to the form's submit event
    $('#uploadForm').submit(function() {
        // inside event callbacks 'this' is the DOM element so we first
        // wrap it in a jQuery object and then invoke ajaxSubmit
        $(this).ajaxSubmit(options);

        // !!! Important !!!
        // always return false to prevent standard browser submit and page navigation
        return false;
    });

    // pre-submit callback
    function showRequest(formData, jqForm, options) {
        // formData is an array; here we use $.param to convert it to a string to display it
        // but the form plugin does this for you automatically when it submits the data
        var queryString = $.param(formData);

        // jqForm is a jQuery object encapsulating the form element.  To access the
        // DOM element for the form do this:
        // var formElement = jqForm[0];

        alert('About to submit: \n\n' + queryString);

        var date = document.getElementsByClassName("date")[0].value;
        var location = document.getElementById("location").value;
        var GPSLocation = document.getElementById("GPSLocation").value;

        var mainCrop = document.getElementById("mainCrop").value;
        if (mainCrop === "Other") {
            mainCrop = document.getElementById("otherMainCrop").value;
        }

        var cropVariety = document.getElementById("cropVariety").value;
        var cropSystem = document.getElementById("cropSystem").value;
        var plantDate = document.getElementsByClassName("date")[1].value;

        var fieldSizeInteger = document.getElementById("fieldSizeInteger").value;
        var fieldSizeDecimal = document.getElementById("fieldSizeDecimal").value;
        var fieldSize;
        if (fieldSizeInteger && fieldSizeDecimal) {
            fieldSize = fieldSizeInteger + "." + fieldSizeDecimal;
        } else {
            fieldSize = "No Value";
        }

        var rainFallDate = document.getElementsByClassName("date")[2].value;
        var pestSpecies = document.getElementById("pestSpecies").value;

        var presence = document.getElementById("presence").checked;
        var absence = document.getElementById("absence").checked;
        var status;
        if (presence) {
            status = document.getElementById("presence").value;
        } else if (absence) {
            status = document.getElementById("absence").value;
        } else {
            status = "";
        }

        var stage = document.getElementById("stage").value;
        var numPerPlant = document.getElementById("numPerPlant").value;
        var numPerPastures = document.getElementById("numPerPastures").value;
        var numPerTrap = document.getElementById("numPerTrap").value;
        var cropInfested = document.getElementById("cropInfested").value;

        var control = document.getElementById("control").value;
        if (control === "Other") {
            mainCrop = document.getElementById("otherControl").value;
        }

        var ifPesticide = document.getElementById("ifPesticide").value;
        var amountOfPesticide;
        if (ifPesticide === "No") {
            amountOfPesticide = "NULL";
        } else if (ifPesticide === "Yes") {
            var amountOfPesticideInteger = document.getElementById("amountOfPesticideInteger").value;
            var amountOfPesticideDecimal = document.getElementById("amountOfPesticideDecimal").value;
            if (amountOfPesticideInteger && amountOfPesticideDecimal) {
                amountOfPesticide = amountOfPesticideInteger + "." + amountOfPesticideDecimal;
            } else {
                amountOfPesticide = "No Value";
            }
        }

        info = [date, location, GPSLocation, mainCrop, cropVariety, cropSystem, plantDate, fieldSize, rainFallDate, pestSpecies, status, stage, numPerPlant, numPerPastures, numPerTrap, cropInfested, control, amountOfPesticide, document.getElementById("photoOfPest").value, document.getElementById("photoOfDamage").value];
        if (date && location && GPSLocation && mainCrop && cropVariety && cropSystem && plantDate && fieldSize !== "No Value" && rainFallDate && pestSpecies && status && stage && numPerPlant && numPerPastures && numPerTrap && cropInfested && control && amountOfPesticide !== "No Value" && document.getElementById("photoOfPest").value && document.getElementById("photoOfDamage").value) {

            // here we could return false to prevent the form from being submitted;
            // returning anything other than false will allow the form submit to continue
            return true;
        } else {
            //for (var i = 0; i < info.length )
            // here we could return false to prevent the form from being submitted;
            // returning anything other than false will allow the form submit to continue
            return false;
        }
    }

    // post-submit callback
    function showResponse(responseText, statusText, xhr, $form) {
        // for normal html responses, the first argument to the success callback
        // is the XMLHttpRequest object's responseText property

        // if the ajaxSubmit method was passed an Options Object with the dataType
        // property set to 'xml' then the first argument to the success callback
        // is the XMLHttpRequest object's responseXML property

        // if the ajaxSubmit method was passed an Options Object with the dataType
        // property set to 'json' then the first argument to the success callback
        // is the json data object returned by the server

        //alert('status: ' + statusText + '\n\nresponseText: \n' + responseText + '\n\nThe output div should have already been updated with the responseText.');

        if (!responseText.error) {
            alert(responseText.message);
            alert("No error!");

            //info[18] = ;
            //info[19] = ;

            for (var i = 0; i < info.length; i++) {
                var insertStatement = "";
                if (info[i] === "NULL"){
                    insertStatement += info[i] + ', '
                } else {
                    insertStatement += '"' + info[i] + '", ';
                }
            }
            insertStatement = insertStatement.substring(0, insertStatement.length - 2);
        } else {
            alert(responseText.message);
            alert("There is an error!");
        }
    }

    var insert = function () {
        var ajaxRequest;
        try{
            // Opera 8.0+, Firefox, Safari
            ajaxRequest = new XMLHttpRequest();
        }catch (e){
            // Internet Explorer Browsers
            try{
                ajaxRequest = new ActiveXObject("Msxml2.XMLHTTP");
            }catch (e) {
                try{
                    ajaxRequest = new ActiveXObject("Microsoft.XMLHTTP");
                }catch (e){
                    // Something went wrong
                    alert("Your browser broke!");
                    return false;
                }
            }
        }

        ajaxRequest.onreadystatechange = function() {
            //alert("xhr status: " + ajaxRequest.readyState);

            if (ajaxRequest.readyState == 4 && ajaxRequest.status == 200) {

                if (ajaxRequest.responseText === "success") {

                    document.getElementById("modal-header").style.backgroundColor = "#5cb85c";
                    document.getElementById("modal-footer").style.display = "none";
                    document.getElementById("close").innerHTML = "&times";

                    document.getElementById("header").innerHTML = "The Insert is Success! Thank you for your Information!";
                    document.getElementById("body").innerHTML = "The page will be refresh after closing this.";

                    document.getElementById("modal").style.display = "block";
                } else if (ajaxRequest.responseText === "fail") {

                    document.getElementById("modal-header").style.backgroundColor = "#f44242";
                    document.getElementById("modal-footer").style.display = "none";
                    document.getElementById("close").innerHTML = "&times";

                    document.getElementById("header").innerHTML = "Sorry. The Insert is Fail !";
                    document.getElementById("body").innerHTML = "Please try again later.";

                    document.getElementById("modal").style.display = "block";
                }

                // Get the <span> element that closes the modal
                var span = document.getElementById("close");

                // When the user clicks on <span> (x), close the modal
                span.onclick = function () {
                    document.getElementById("modal").style.display = "none";
                    if (ajaxRequest.responseText === "success") {
                        location.reload();
                    }
                    document.body.scrollTop = 0;
                    document.documentElement.scrollTop = 0;

                };

                // When the user clicks anywhere outside of the modal, close it
                window.onclick = function (event) {
                    if (event.target == modal) {
                        document.getElementById("modal").style.display = "none";
                        if (ajaxRequest.responseText === "success") {
                            location.reload();
                        }
                        document.body.scrollTop = 0;
                        document.documentElement.scrollTop = 0;
                    }
                };
            }
        };

        var querystring = "?statement=" + insertStatement;
        ajaxRequest.open("GET", "//10.11.4.90:9088/insert" + querystring, true);
        ajaxRequest.send(querystring);
    };
    function undisableBtn() {
        document.getElementById("myBtn").disabled = false;
    }

</script>
</body>
</html>